name: Go CI

on:
  push:
    branches: [ "main" ]
    paths-ignore: # ğŸ”¥ åªæœ‰æ”¹ä»£ç æ‰è·‘æµ‹è¯•ï¼Œæ”¹æ–‡æ¡£ä¸è·‘
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ "main" ]

jobs:
  # ğŸ”¥ æ–°å¢ Jobï¼šä»£ç é£æ ¼æ£€æŸ¥
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    # ç­‰ Lint é€šè¿‡äº†å†è·‘æµ‹è¯•ï¼Œæˆ–è€…å¹¶è¡Œè·‘ï¼ˆæ ¹æ®èµ„æºæƒ…å†µï¼‰
    needs: lint 

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Install dependencies
      run: go mod download

    - name: Start Services
      # å¾ˆå¥½ï¼Œä½ ç”¨äº† --waitï¼Œä¿æŒä½
      run: docker compose -f deploy/docker-compose.yml up -d --wait

    - name: Run Tests
      # ğŸ”¥ æ³¨å…¥ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶è¦†ç›– config.yaml
      # å³ä½¿ config.yaml å†™çš„æ˜¯ localhostï¼Œè¿™é‡Œä¹Ÿèƒ½ç¡®ä¿ä¸‡æ— ä¸€å¤±
      env:
        MALL_DATABASE_HOST: localhost
        MALL_DATABASE_PORT: 5432
        MALL_DATABASE_DBNAME: mall_db
        # MALL_REDIS_ADDR: localhost:6379
        # å¦‚æœä½ ä¹‹å‰ç”¨äº† Viper è‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œå°±ä¼šç”Ÿæ•ˆ
      run: |
        go test -race -v -coverprofile=coverage.out ./...

    - name: Shutdown Services
      if: always() # å³ä½¿æµ‹è¯•æŒ‚äº†ä¹Ÿè¦æ¸…ç†
      run: docker compose -f deploy/docker-compose.yml down